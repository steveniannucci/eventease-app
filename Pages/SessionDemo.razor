@page "/session-demo"
@using EventEaseApp.Services
@inject UserSessionTracker Session
@implements IDisposable

<h1>Session Tracker Demo</h1>

<div class="card mb-3">
    <div class="card-body">
        <h5 class="card-title">Session Info</h5>
        <p><strong>User ID:</strong> @(Session.UserId ?? "Not set")</p>
        <p><strong>User Name:</strong> @(Session.UserName ?? "Not set")</p>
        <p><strong>Authenticated:</strong> @Session.IsAuthenticated</p>
        <p><strong>Session Duration:</strong> @Session.SessionDuration.ToString(@"hh\:mm\:ss")</p>
        <p><strong>Registered Events:</strong> @Session.RegisteredEventIds.Count</p>
    </div>
</div>

<div class="card mb-3">
    <div class="card-body">
        <h5 class="card-title">Set User</h5>
        <input @bind="userId" class="form-control mb-2" placeholder="User ID" />
        <input @bind="userName" class="form-control mb-2" placeholder="User Name" />
        <button class="btn btn-primary" @onclick="SetUser">Set User</button>
    </div>
</div>

<div class="card mb-3">
    <div class="card-body">
        <h5 class="card-title">Event Registration</h5>
        <input @bind="eventId" type="number" class="form-control mb-2" placeholder="Event ID" />
        <button class="btn btn-success me-2" @onclick="RegisterEvent">Register</button>
        <button class="btn btn-warning me-2" @onclick="UnregisterEvent">Unregister</button>
        
        @if (Session.RegisteredEventIds.Any())
        {
            <div class="mt-3">
                <strong>Registered for events:</strong>
                <ul>
                    @foreach (var id in Session.RegisteredEventIds)
                    {
                        <li>Event #@id</li>
                    }
                </ul>
            </div>
        }
    </div>
</div>

<div class="card">
    <div class="card-body">
        <h5 class="card-title">Session Actions</h5>
        <button class="btn btn-danger" @onclick="ClearSession">Clear Session</button>
    </div>
</div>

@code {
    private string userId = "";
    private string userName = "";
    private int eventId = 1;

    protected override void OnInitialized()
    {
        Session.OnStateChanged += OnSessionStateChanged;
    }

    private void OnSessionStateChanged()
    {
        InvokeAsync(StateHasChanged);
    }

    private void SetUser()
    {
        Session.UserId = userId;
        Session.UserName = userName;
    }

    private void RegisterEvent()
    {
        Session.RegisterForEvent(eventId);
    }

    private void UnregisterEvent()
    {
        Session.UnregisterFromEvent(eventId);
    }

    private void ClearSession()
    {
        Session.ClearSession();
        userId = "";
        userName = "";
    }

    public void Dispose()
    {
        Session.OnStateChanged -= OnSessionStateChanged;
    }
}
